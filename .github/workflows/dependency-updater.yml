name: dependency-updater

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:
  push:
    branches:
    - dependency-updater-sed
      
jobs:
  update-latest-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool: ['ytt', 'kapp', 'kbld', 'imgpkg', 'vendir']
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get Current Release Version
        id: current-version
        run: |
          set -eou pipefail
          echo ::set-output name=version::$(grep "${{ matrix.tool }}_version=v" hack/install-deps.sh | cut -d "=" -f2)
      - name: Get Latest Release Version
        id: latest-version
        run: |
          set -eou pipefail
          echo ::set-output name=version::$(curl -sL https://api.github.com/repos/vmware-tanzu/carvel-${{ matrix.tool }}/releases/latest | jq -r '.tag_name')
      - name: Update Dependencies File
        if: ${{ steps.current-version.outputs.version }} != ${{ steps.latest-version.outputs.version }}
        run: |
          set -eou pipefail
          
          old_darwin_amd64_sha=$(grep darwin-amd64 hack/install-deps.sh -A 5 | grep ${{ matrix.tool }}_checksum | cut -d "=" -f2)
          old_linux_amd64_sha=$(grep linux-amd64 hack/install-deps.sh -A 5 | grep ${{ matrix.tool }}_checksum | cut -d "=" -f2)
                  
          release_notes=$(curl https://api.github.com/repos/vmware-tanzu/carvel-${{ matrix.tool }}/releases/latest | jq .body -r)
          new_darwin_amd64_sha=$( echo "$release_notes" | grep ${{ matrix.tool }}-darwin-amd64 | awk '{print $1;}')
          new_linux_amd64_sha=$( echo "$release_notes" | grep ${{ matrix.tool }}-linux-amd64 | awk '{print $1;}')
          
          sed -i '/${{ matrix.tool }}_version/s/${{ steps.current-version.outputs.version }}/${{ steps.latest-version.outputs.version }}/g' ./hack/install-deps.sh
          sed -i "/${{ matrix.tool }}_checksum/s/${old_darwin_amd64_sha}/${new_darwin_amd64_sha}/g" ./hack/install-deps.sh
          sed -i "/${{ matrix.tool }}_checksum/s/${old_linux_amd64_sha}/${new_linux_amd64_sha}/g" ./hack/install-deps.sh
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@f22a7da129c901513876a2380e2dae9f8e145330
        with:
          commit-message: Bump ${{ matrix.tool }} to ${{ steps.latest-version.outputs.version }}
          title: Bump ${{ matrix.tool }} to ${{ steps.latest-version.outputs.version }}
          delete-branch: true
          body: |
            Auto-generated by https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
          base: develop
          branch: bump-${{ matrix.tool }}-${{ steps.latest-version.outputs.version }}
          
         
